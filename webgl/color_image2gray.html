<!DOCTYPE html>
  <head>
    <title>Color Image To Gray Image</title>
    <script src="../libs/baidu_tongji.js"></script>
  </head>
  <body>
    <canvas id="canvas" width="500" height="500" style="background-color: black;"></canvas>
    <script>
      const canvas = document.getElementById('canvas');
      const gl = canvas.getContext('webgl');
      const vertexShaderSource = `
        varying vec2 v_texCoord;
        attribute vec4 apos;
        attribute vec2 a_texCoord;
        void main () {
          gl_Position = apos;
          v_texCoord = a_texCoord;
        }
      `;
      const fragShaderSource = `
        precision highp float;
        varying vec2 v_texCoord;
        uniform sampler2D u_sampler;
        void main () {
          vec4 color = texture2D(u_sampler, v_texCoord);
          float luminance = color.r * 0.299 + color.g * 0.587 + color.b * 0.114;
          gl_FragColor = vec4(luminance, luminance, luminance, 0.7);
        }
      `;
      const vertexShader = gl.createShader(gl.VERTEX_SHADER);
      const fragmentShader = gl.createShader(gl.FRAGMENT_SHADER);
      gl.shaderSource(vertexShader, vertexShaderSource);
      gl.shaderSource(fragmentShader, fragShaderSource);
      gl.compileShader(vertexShader);
      gl.compileShader(fragmentShader);
      const program = gl.createProgram();
      gl.attachShader(program, vertexShader);
      gl.attachShader(program, fragmentShader);
      gl.linkProgram(program);
      gl.useProgram(program);

      const attribData = new Float32Array([
        -.5, 0.5,
        0, 1.0,
        0.5, 0.5,
        1.0, 1.0,
        -.5, -.5,
        0, 0,
        0.5, -.5,
        1.0, 0.0
      ])
      const attribBuffer = gl.createBuffer();
      gl.bindBuffer(gl.ARRAY_BUFFER, attribBuffer);
      gl.bufferData(gl.ARRAY_BUFFER, attribData, gl.STATIC_DRAW);
      const aposAttrib = gl.getAttribLocation(program, 'apos');
      gl.vertexAttribPointer(aposAttrib, 2, gl.FLOAT, false, 4 * 4, 0);
      gl.enableVertexAttribArray(aposAttrib);
      const texCoordAttrib = gl.getAttribLocation(program, 'a_texCoord');
      gl.vertexAttribPointer(texCoordAttrib, 2, gl.FLOAT, false, 4 * 4, 4 * 2);
      gl.enableVertexAttribArray(texCoordAttrib);
      const image = new Image();
      image.onload = loadTexture;
      image.src = './webgl23texture.jpg';

      function loadTexture () {
        const textureBuffer = gl.createTexture();
        gl.pixelStorei(gl.UNPACK_FLIP_Y_WEBGL, true);
        gl.activeTexture(gl.TEXTURE0);
        gl.bindTexture(gl.TEXTURE_2D, textureBuffer);
        gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MIN_FILTER, gl.LINEAR);
        gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MAG_FILTER, gl.LINEAR);
        gl.texImage2D(gl.TEXTURE_2D, 0, gl.RGB, gl.RGB, gl.UNSIGNED_BYTE, image);

        gl.drawArrays(gl.TRIANGLE_STRIP, 0, 4);
      }
    </script>
  </body>
</html>
